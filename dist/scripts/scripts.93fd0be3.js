"use strict";angular.module("asbuiltsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","autocomplete"]).config(["$routeProvider","$httpProvider",function(a,b){a.when("/",{templateUrl:"views/form.html",controller:"FormCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).when("/form",{templateUrl:"views/form.html",controller:"FormCtrl"}).otherwise({redirectTo:"/"}),b.defaults.useXDomain=!0,delete b.defaults.headers.common["X-Requested-With"]}]),angular.module("asbuiltsApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("asbuiltsApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("asbuiltsApp").controller("FormCtrl",["$scope","$http","$filter",function(a,b,c){function d(b,c,d){for(var e in b[c])if(b[c][e].name===d)if("layers"===c)a.servers[0].test[c].id=b[c][e].id;else for(var f in a.servers[0].test.tables)a.servers[0].test[c][f].name===d&&(a.servers[0].test[c][f].id=b[c][e].id)}function e(a){var b=[];for(var c in a)b.push(a[c].attributes.DOCID);return b.sort(function(a,b){return b-a}),b[0]}a.fields=null,a.projects=null,a.stat=!0,a.formSuccess=!1,a.selections=[{name:!0,id:1},{name:!1,id:0}],a.selectionOptions={project:"--Please Select Project--",doctype:"--Please Select Document Type--",engineer:"--Please Select Engineering Firm--",tf:"--Please Select--",sheet:"--Please Select Sheet--"};var f=0;a.servers=[{test:{FeatureServer:"http://mapstest.raleighnc.gov/arcgis/rest/services/PublicUtility/ProjectTracking/FeatureServer",layers:{id:null,name:"Project Tracking"},tables:[{id:null,name:"RPUD.ASBUILTS"},{id:null,name:"RPUD.EngineeringFirms"}]}},{WAKE:{Addresses:"http://maps.raleighnc.gov/arcgis/rest/services/Addresses/MapServer/0/query"}}],a.doctypes=[{type:"AS-BUILT DRAWING"},{type:"CONSTRUCTION DRAWING"},{type:"WARRANTY LETTER"},{type:"ACCEPTANCE LETTER"},{type:"STATEMENT OF COST"}],a.sheetdisc=[{type:"COVER SHEET"},{type:"OVERALL PLAN"},{type:"EXISTING CONDITIONS"},{type:"UTILITY PLAN"},{type:"GRADING & DRAINAGE"},{type:"PLAN/PROFILE"},{type:"DETAILS"},{type:"NOTES/LEGEND"},{type:"DEMOLITION PLAN"},{type:"EROSION CONTROL PLAN"},{type:"LANDSCAPE PLAN"},{type:"ROAD CROSS SECTIONS"},{type:"SUBDIVISION PLAN"},{type:"OTHER"}],a.sheetdisc=c("orderBy")(a.sheetdisc,"type"),a.doctypes=c("orderBy")(a.doctypes,"type"),b.get(a.servers[0].test.FeatureServer,{params:{f:"json"}}).success(function(b){d(b,"layers",a.servers[0].test.layers.name);for(var c in a.servers[0].test.tables)d(b,"tables",a.servers[0].test.tables[c].name)}),setTimeout(function(){b.get(a.servers[0].test.FeatureServer+"/"+a.servers[0].test.tables[0].id,{params:{f:"json"},cache:!0}).success(function(b){console.log(b),a.fields=b.fields});var c=function(c,d,e){var f={f:"json",outFields:"*",where:"OBJECTID >"+c,orderByFields:d+" ASC",returnGeometry:!1};if("layers"===e)var g=a.servers[0].test.FeatureServer+"/"+a.servers[0].test[e].id+"/query";else{var g=a.servers[0].test.FeatureServer+"/"+a.servers[0].test[e][1].id+"/query";console.log(g),console.log(a.servers)}b.get(g,{params:f}).success(function(b){console.log(b),"layers"===e?a.projects=b.features:a.engfirms=b.features})};c(f,"PROJECTNAME","layers"),c(f,"SIMPLIFIEDNAME","tables")},1e3),a.change=function(d){var f=["SEALDATE","SEALNUMBER","ENGINEERINGFIRM","FORMERNAME","ALIAS"],g=["DEVPLANID","PROJECTID"],h={f:"json",outFields:"*",where:"DEVPLANID =  '"+d.PROJECTNAME.attributes.DEVPLANID+"'",orderByFields:"PROJECTNAME ASC",returnGeometry:!1};b.get(a.servers[0].test.FeatureServer+"/"+a.servers[0].test.tables[0].id+"/query",{params:h}).success(function(b){console.log(b),a.sheets=b.features;for(var d in a.sheets)if(a.sheets[d].attributes.DOCID<10){var g="0"+a.sheets[d].attributes.DOCID.toString();a.sheets[d].attributes.DOCID=parseInt(g)}if(a.sheetFields=b.fields,0===a.sheets.length){a.sheets=!1;for(var h in f)a.form[f[h]]=null;a.form.DOCID=1}else{a.form.DOCID=e(a.sheets)+1;for(var h in f)a.form[f[h]]=a.sheets[0].attributes[f[h]],a.form.SEALDATE=c("date")(a.sheets[0].attributes.SEALDATE,"yyyy-MM-dd"),a.selectionOptions.engineer=a.sheets[0].attributes.ENGINEERINGFIRM}});for(var i in g)a.form[g[i]]=d.PROJECTNAME.attributes[g[i]]},a.autoFill=function(c){var d={f:"json",outFields:"ADDRESS",text:c,returnGeometry:!1,orderByFields:"ADDRESS ASC"},e=a.servers[1].WAKE.Addresses;b.get(e,{params:d,cache:!0}).success(function(b){console.log(b),a.streets=[];for(var c in b.features)a.streets.push(b.features[c].attributes.ADDRESS)})},a.nextSheet=function(){a.selectionOptions.project=a.entry.PROJECTNAME,a.selectionOptions.engineer=a.entry.ENGINEERINGFIRM,a.form={PROJECTNAME:a.entry.PROJECTNAME,SEALDATE:a.lastDate,SEALNUMBER:a.entry.SEALNUMBER,ENGINEERINGFIRM:a.entry.ENGINEERINGFIRM,DEVPLANID:a.entry.DEVPLANID,JURISDICTION:a.entry.JURISDICTION,PROJECTID:a.entry.PROJECTID}},a.delete=function(){b.post(a.servers[0].test.FeatureServer+"/"+a.servers[0].test.tables[0].id+"/deleteFeatures",a.postResults,{params:{f:"json",objectIds:a.postResults.objectId},headers:{"Content-Type":"text/plain"}}).success(function(b){console.log(b),a.sheets.pop()})},a.submit=function(c){console.log(c),a.lastDate=c.SEALDATE;var d=c.SEALDATE.split("-"),e=d[1]+"/"+d[2]+"/"+d[0];console.log(e);var f={PROJECTNAME:c.PROJECTNAME.attributes.PROJECTNAME,SEALDATE:e,SEALNUMBER:c.SEALNUMBER,DOCTYPE:c.DOCTYPE.type,DOCID:c.DOCID,ENGINEERINGFIRM:c.ENGINEERINGFIRM.attributes.SIMPLIFIEDNAME.toUpperCase(),WATER:c.WATER.id,SEWER:c.SEWER.id,REUSE:c.REUSE.id,STORM:c.STORM.id,FORMERNAME:c.FORMERNAME||null,ALIAS:c.ALIAS||null,DEVPLANID:c.DEVPLANID,STREET_1:c.STREET_1||null,STREET_2:c.STREET_2||null,STREET_3:c.STREET_3||null,STREET_4:c.STREET_4||null,NOTES:c.NOTES||null,TAGS:c.TAGS||null,PROJECTID:c.PROJECTNAME.attributes.PROJECTID,SHEETDESCRIPTION:c.SHEETDESCRIPTION.type};a.sheets!==!1&&(f.SEALDATE=a.sheets.SEALDATE),a.stat=!1,a.entry=f;var g=[{attributes:f}],h=angular.toJson(g),i={params:{f:"json",features:h},headers:{"Content-Type":"text/plain"}};b.post(a.servers[0].test.FeatureServer+"/"+a.servers[0].test.tables[0].id+"/addFeatures",f,i).success(function(b){console.log(b),a.form.$setPristine(),a.formSuccess=!0,a.form={},a.postResults=b.addResults[0],a.sheets.push({attributes:f})})}}]);